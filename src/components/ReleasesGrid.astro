---
import AlbumCard from './AlbumCard.astro';
import SingleCard from './SingleCard.astro';
import type { Release } from '../types/releases';

interface Props {
  releases: Release[];
}

const { releases } = Astro.props;

// Sort all releases newest-first
const sorted = [...releases].sort(
  (a, b) => new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
);

// Group consecutive singles into grids; albums/EPs stay as individual full-width cards
type MultiGroup = { kind: 'multi'; release: Release };
type SingleGroup = { kind: 'singles'; releases: Release[] };
type Group = MultiGroup | SingleGroup;

const groups: Group[] = [];
for (const release of sorted) {
  if (release.type === 'single') {
    const last = groups[groups.length - 1];
    if (last?.kind === 'singles') {
      last.releases.push(release);
    } else {
      groups.push({ kind: 'singles', releases: [release] });
    }
  } else {
    groups.push({ kind: 'multi', release });
  }
}
---
<div class="space-y-8">
  {groups.map(group => (
    group.kind === 'multi' ? (
      <AlbumCard release={group.release} />
    ) : (
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {group.releases.map(release => (
          <SingleCard release={release} />
        ))}
      </div>
    )
  ))}
</div>
